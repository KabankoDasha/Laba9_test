name: Run Tests

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Получаем код
    - uses: actions/checkout@v3
    
    # 2. Устанавливаем Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    # 3. Устанавливаем зависимости Python
    - name: Install Python dependencies
      run: |
        pip install pytest selenium requests pytest-html
    
    # 4. Устанавливаем Chrome и ChromeDriver ПРАВИЛЬНО
    - name: Setup Chrome and ChromeDriver
      run: |
        # Устанавливаем Chrome
        sudo apt-get update
        sudo apt-get install -y wget gnupg
        
        # Добавляем репозиторий Google Chrome
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # Получаем ПОЛНУЮ версию Chrome
        CHROME_FULL_VERSION=$(google-chrome --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+')
        echo "Chrome full version: $CHROME_FULL_VERSION"
        
        # Скачиваем ChromeDriver ТОЙ ЖЕ версии
        wget -q "https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/$CHROME_FULL_VERSION/linux64/chromedriver-linux64.zip"
        unzip -q chromedriver-linux64.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        
        # Проверяем установку
        echo "Chrome version:"
        google-chrome --version
        echo "ChromeDriver version:"
        chromedriver --version
    
    # 5. Запускаем тесты
    - name: Run API tests
      run: |
        echo "=== Запуск API тестов ==="
        python -m pytest tests/test_api.py -v --tb=short
    
    - name: Run Unit tests
      run: |
        echo "=== Запуск модульных тестов ==="
        python -m pytest tests/test_unit.py -v --tb=short
    
    - name: Run UI tests
      run: |
        echo "=== Запуск UI тестов ==="
        # Для headless режима Selenium
        export DISPLAY=:99
        Xvfb :99 -screen 0 1920x1080x24 &
        sleep 3
        
        python -m pytest tests/test_ui.py -v --tb=short
        
        # Останавливаем Xvfb
        pkill -f Xvfb