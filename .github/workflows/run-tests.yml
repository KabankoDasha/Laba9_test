name: Run Tests

on: [push, pull_request]  # Запускать при push и pull request

jobs:
  test:
    runs-on: ubuntu-latest  # Используем последнюю версию Ubuntu
    
    steps:
    # 1. Получаем код из репозитория
    - name: Checkout repository
      uses: actions/checkout@v3
    
    # 2. Устанавливаем Python 3.9
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    # 3. Обновляем pip и устанавливаем зависимости
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest==8.0.0
        pip install requests==2.31.0
        pip install selenium==4.15.2
        pip install pytest-html==4.1.1
    
    # 4. Устанавливаем Chrome и ChromeDriver для UI-тестов
    - name: Setup Chrome and ChromeDriver
      run: |
        # Устанавливаем Chrome
        sudo apt-get update
        sudo apt-get install -y wget unzip
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # Устанавливаем ChromeDriver
        CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d '.' -f 1)
        echo "Chrome version: $CHROME_VERSION"
        
        # Скачиваем ChromeDriver
        wget -q "https://storage.googleapis.com/chrome-for-testing-public/$CHROME_VERSION.0.0/linux64/chromedriver-linux64.zip"
        unzip -q chromedriver-linux64.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        
        # Проверяем установку
        chromedriver --version
    
    # 5. Проверяем установленные пакеты (для отладки)
    - name: Check installed packages
      run: |
        python -c "import pytest; print(f'pytest version: {pytest.__version__}')"
        python -c "import requests; print(f'requests version: {requests.__version__}')"
        python -c "import selenium; print(f'selenium version: {selenium.__version__}')"
        echo "Chrome version:"
        google-chrome --version
        echo "ChromeDriver version:"
        chromedriver --version
    
    # 6. Запускаем API тесты
    - name: Run API Tests
      run: |
        echo "=== Запуск API тестов ==="
        python -m pytest tests/test_api.py -v --tb=short
    
    # 7. Запускаем модульные тесты
    - name: Run Unit Tests
      run: |
        echo "=== Запуск модульных тестов ==="
        python -m pytest tests/test_unit.py -v --tb=short
    
    # 8. Запускаем UI тесты
    - name: Run UI Tests
      run: |
        echo "=== Запуск UI тестов ==="
        # Устанавливаем переменную окружения для headless режима
        export DISPLAY=:99
        Xvfb :99 -screen 0 1024x768x24 &
        
        # Запускаем тесты
        python -m pytest tests/test_ui.py -v --tb=short
        
        # Останавливаем Xvfb
        pkill -f Xvfb
    
    # 9. Генерируем отчет (опционально)
    - name: Generate test report
      if: always()  # Выполнять всегда, даже при ошибках
      run: |
        echo "=== Генерация отчета ==="
        python -m pytest tests/ --html=test-report.html --self-contained-html || true
    
    # 10. Сохраняем отчет как артефакт
    - name: Upload test report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: my-artifact
        path: path/to/artifact/